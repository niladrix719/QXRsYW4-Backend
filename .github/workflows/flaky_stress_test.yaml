name: Stress Test New Go Tests

on: [pull_request]

jobs:
  stress-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'  # Adjust to your Go version

      - name: Find New Tests
        run: |
          git fetch origin main
          NEW_TESTS=$(git diff origin/main -- '*.go' | grep -E '^\+' | grep -E 'func Test' | awk '{print $3}')
          echo "New tests: $NEW_TESTS"
          echo "$NEW_TESTS" > new_tests.txt

      - name: Stress Test New Tests
        run: |
          if [ -s new_tests.txt ]; then
            while IFS= read -r test; do
              echo "Running stress test for $test"
              for i in {1..10}; do
                go test -run "^$test$" ./... || exit 1
              done
            done < new_tests.txt
          else
            echo "No new tests found."
          fi
